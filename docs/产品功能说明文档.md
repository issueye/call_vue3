# 医疗呼叫客户端 - 产品功能说明文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 产品名称 | 医疗呼叫客户端 |
| 产品版本 | v1.0.0 |
| 文档版本 | v1.0.0 |
| 编写日期 | 2026-01-07 |
| 技术架构 | Wails v2 (Go + Vue 3) |

---

## 一、产品概述

### 1.1 产品定位

医疗呼叫客户端是一款面向医疗机构诊室的桌面应用程序，旨在帮助医生高效管理患者就诊流程。通过简洁直观的界面，实现患者呼叫、过号、结诊等核心就诊流程的数字化管理。

### 1.2 核心价值

- **提升效率**：简化患者呼叫流程，减少人工操作
- **实时同步**：患者状态实时更新，避免信息滞后
- **多端适配**：支持桌面端和移动端，灵活适应不同场景
- **稳定可靠**：本地化部署，保障系统稳定运行

### 1.3 目标用户

- 医生：使用系统呼叫患者、管理就诊流程
- 诊室护士：协助管理患者排队和状态
- 医院管理员：配置系统参数和设备信息

---

## 二、功能架构

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                     医疗呼叫客户端                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │  用户认证    │  │  患者管理    │  │  呼叫操作    │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
│                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │  实时通信    │  │  状态管理    │  │  设备管理    │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
│                                                         │
├─────────────────────────────────────────────────────────┤
│                   后端服务层 (Go)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │  进程管理    │  │  配置管理    │  │  日志系统    │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
├─────────────────────────────────────────────────────────┤
│                   数据层                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │  本地配置    │  │  HTTP API    │  │  MQTT 消息   │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 2.2 技术架构

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| 前端框架 | Vue 3 | 使用 Composition API |
| 状态管理 | Pinia | 支持状态持久化 |
| 路由管理 | Vue Router 4 | 页面路由控制 |
| HTTP 客户端 | Axios | API 请求处理 |
| 实时通信 | MQTT.js | 消息订阅推送 |
| 桌面框架 | Wails v2 | Go + Vue 3 混合开发 |
| 后端语言 | Go 1.21+ | 高性能后端服务 |
| 配置管理 | YAML | 灵活的配置管理 |

---

## 三、核心功能

### 3.1 用户认证

#### 3.1.1 登录功能

**功能描述：**
用户通过账号密码登录系统，获取访问令牌。

**功能流程：**
1. 用户输入账号和密码
2. 系统验证用户身份
3. 登录成功后返回 Token 和用户信息
4. 保存登录状态到本地存储
5. 跳转到工作台页面

**输入参数：**
- `username`: 用户名（必填）
- `password`: 密码（必填）

**返回信息：**
- `token`: 访问令牌
- `userInfo`: 用户基本信息
- `org`: 机构信息
- `room`: 诊室信息

---

#### 3.1.2 登出功能

**功能描述：**
用户退出登录，清除本地状态。

**功能流程：**
1. 用户点击登出按钮
2. 清除本地 Token 和用户信息
3. 断开 MQTT 连接
4. 跳转到登录页面

---

### 3.2 患者管理

#### 3.2.1 患者列表

**功能描述：**
展示当前医生的患者排队列表，支持多种状态筛选。

**列表状态：**
- **候诊中**：等待就诊的患者（state=2）
- **过号**：已过号的患者（state=3）
- **结诊**：已结束就诊的患者（state=4）

**显示信息：**
- 患者姓名
- 就诊序号
- 排队序号
- 患者状态标签
- 就诊时间（如已就诊）

**操作功能：**
- 下拉刷新
- 状态切换（候诊/过号/结诊）
- 点击查看患者详情

---

#### 3.2.2 在诊患者

**功能描述：**
显示当前正在就诊的患者信息。

**显示位置：**
- 工作台顶部卡片区域
- 实时更新当前就诊状态

**显示信息：**
- 患者姓名
- 就诊序号
- 开始就诊时间
- 患者状态标识

---

#### 3.2.3 患者详情

**功能描述：**
查看患者的详细信息。

**详情内容：**
- 患者基本信息
- 排队信息
- 就诊历史
- 当前状态

---

### 3.3 呼叫操作

#### 3.3.1 呼叫患者

**功能描述：**
呼叫指定患者到诊室就诊。

**操作流程：**
1. 选择要呼叫的患者
2. 点击"呼叫"按钮
3. 系统发送呼叫指令
4. 更新患者状态为"就诊中"
5. 更新在诊患者信息

**API 调用：**
```
POST /api/triage/pat/call
参数: { patId: "患者ID" }
```

**系统反馈：**
- 呼叫成功提示
- 患者状态自动更新
- MQTT 推送状态变更

---

#### 3.3.2 下一位

**功能描述：**
自动呼叫队列中的下一位患者。

**操作逻辑：**
1. 获取候诊列表第一位患者
2. 自动执行呼叫操作
3. 更新当前在诊患者

**适用场景：**
- 快速连续呼叫多个患者
- 标准就诊流程

---

#### 3.3.3 重呼

**功能描述：**
重新呼叫当前在诊患者。

**使用场景：**
- 患者未听到呼叫
- 需要提醒患者
- 语音播报需要重复

---

#### 3.3.4 过号

**功能描述：**
将当前患者标记为过号状态。

**操作流程：**
1. 选择要过号的患者
2. 点击"过号"按钮
3. 确认过号操作
4. 更新患者状态为"过号"
5. 患者返回候诊队列末尾

**状态变更：**
```
候诊中 → 过号 → 可重新呼叫
```

---

#### 3.3.5 结诊

**功能描述：**
完成当前患者的就诊。

**操作流程：**
1. 选择要结诊的患者
2. 点击"结诊"按钮
3. 确认结诊操作
4. 更新患者状态为"已结诊"
5. 清空在诊患者信息

**状态变更：**
```
就诊中 → 已结诊
```

---

### 3.4 医生工作台

#### 3.4.1 工作台布局

**桌面端布局（宽度 ≥ 420px）：**
- 左侧：患者列表（70%）
- 右侧：操作区和患者详情（30%）

**移动端布局（宽度 < 420px）：**
- 上部：患者详情和操作区
- 下部：患者列表

**响应式适配：**
- 自动根据窗口大小切换布局
- 保持界面元素可用性

---

#### 3.4.2 工作台头部

**显示信息：**
- 机构名称
- 诊室名称
- 医生姓名
- 当前时间

**操作按钮：**
- 刷新患者列表
- 返回登录

---

#### 3.4.3 统计信息

**实时统计：**
- 候诊人数
- 过号人数
- 结诊人数
- 已就诊人数

**数据来源：**
- 患者列表实时计算
- 状态标签动态统计

---

### 3.5 实时通信

#### 3.5.1 MQTT 连接

**连接配置：**
- 从后端获取 MQTT 服务器信息
- 自动建立连接
- 支持断线重连

**连接状态：**
- 连接中：正在建立连接
- 已连接：正常通信
- 重连中：连接断开正在重连
- 未连接：连接失败

---

#### 3.5.2 消息订阅

**订阅主题：**

1. **医生状态更新**
   ```
   主题格式: {orgCode}/doctor/status
   消息内容: 医生开诊/停诊状态
   ```

2. **患者信息更新**
   ```
   主题格式: {orgCode}/department/{deptId}/patient/update
   消息内容: 患者状态变更
   ```

**消息处理：**
- 接收实时推送
- 自动更新本地状态
- 触发界面刷新

---

### 3.6 设备管理

#### 3.6.1 设备注册检查

**功能描述：**
检查当前设备是否已注册到系统。

**检查时机：**
- 应用启动时
- 用户登录后
- 手动刷新时

**检查结果：**
- 已注册：正常使用系统
- 未注册：提示联系管理员

---

#### 3.6.2 设备状态

**状态标识：**
- `deviceRegistered`: 设备是否已注册
- `deviceError`: 设备错误信息

**错误处理：**
- 显示错误提示
- 引导用户处理

---

### 3.7 医生状态管理

#### 3.7.1 开诊

**功能描述：**
医生开始接诊，更新医生状态为"开诊"。

**操作流程：**
1. 医生点击"开诊"按钮
2. 调用开诊 API
3. 更新医生状态
4. 通知系统更新

---

#### 3.7.2 停诊

**功能描述：**
医生结束接诊，更新医生状态为"停诊"。

**操作流程：**
1. 医生点击"停诊"按钮
2. 调用停诊 API
3. 更新医生状态
4. 清空当前患者信息

---

### 3.8 诊室管理

#### 3.8.1 诊室列表

**功能描述：**
获取机构下的所有诊室信息。

**信息内容：**
- 诊室 ID
- 诊室名称
- 诊室位置
- 关联科室

---

#### 3.8.2 诊室分配

**功能描述：**
将患者分配到指定诊室。

**使用场景：**
- 转诊操作
- 诊室调整

---

## 四、系统管理

### 4.1 配置管理

#### 4.1.1 应用配置

**配置文件：** `configs/app.yaml`

**配置项：**

```yaml
# 应用窗口配置
app:
  title: "呼叫客户端"           # 窗口标题
  width: 430                     # 窗口宽度
  height: 800                    # 窗口高度
  min_width: 430                 # 最小宽度
  min_height: 550                # 最小高度
  max_width: 750                 # 最大宽度
  max_height: 700                # 最大高度
  always_on_top: false           # 窗口置顶

# 呼叫进程配置
process:
  exe_path: "build/bin/root/process/suwei_caller_local.exe"
  port: 21999                    # 进程端口
  args: "--port=%d"              # 启动参数
  start_retry: 3                 # 启动重试次数
  retry_delay_ms: 1000          # 重试延迟（毫秒）

# 日志配置
logging:
  level: "debug"                 # 日志级别
  output: "stdout"              # 输出方式
```

---

#### 4.1.2 环境变量

**支持的覆盖变量：**

| 变量名 | 说明 | 示例 |
|--------|------|------|
| CALLER_PORT | 呼叫进程端口 | `CALLER_PORT=21999` |
| CALLER_EXE_PATH | 进程可执行文件路径 | `CALLER_EXE_PATH=/path/to/exe` |
| LOG_LEVEL | 日志级别 | `LOG_LEVEL=debug` |

---

### 4.2 日志管理

#### 4.2.1 日志级别

| 级别 | 说明 | 使用场景 |
|------|------|----------|
| DEBUG | 调试信息 | 开发和问题排查 |
| INFO | 一般信息 | 正常业务流程 |
| WARN | 警告信息 | 需要注意但不影响运行 |
| ERROR | 错误信息 | 功能异常但系统继续运行 |
| FATAL | 致命错误 | 系统无法继续运行 |

---

#### 4.2.2 日志输出

**输出方式：**
- 标准输出（控制台）
- 文件输出（可配置）

**日志格式：**
```
[时间] [级别] [模块] 消息内容
```

---

### 4.3 进程管理

#### 4.3.1 呼叫进程

**进程名称：** `suwei_caller_local.exe`

**进程功能：**
- 处理语音播报
- 管理呼叫设备
- 维护呼叫连接

**生命周期：**
- 应用启动时自动启动
- 应用关闭时自动停止
- 支持健康检查
- 支持手动重启

---

#### 4.3.2 进程监控

**监控指标：**
- 进程运行状态
- 进程端口占用
- 进程响应时间

**异常处理：**
- 自动重试启动
- 记录错误日志
- 提示用户处理

---

## 五、用户界面

### 5.1 登录页面

**页面元素：**
- 应用标题/Logo
- 账号输入框
- 密码输入框
- 登录按钮

**界面特点：**
- 简洁清爽
- 居中布局
- 输入验证

---

### 5.2 工作台页面

**页面布局：**

```
┌────────────────────────────────────────┐
│              头部信息栏                 │
├────────────────────────────────────────┤
│                                        │
│  ┌──────────┐  ┌──────────────────┐   │
│  │          │  │   在诊患者卡片    │   │
│  │  患者    │  │                  │   │
│  │  列表    │  ├──────────────────┤   │
│  │          │  │   呼叫操作按钮    │   │
│  │          │  │                  │   │
│  │          │  └──────────────────┘   │
│  │          │                         │
│  └──────────┘                         │
│                                        │
│  ┌────────────────────────────────┐   │
│  │     标签切换 [候诊|过号|结诊]   │   │
│  └────────────────────────────────┘   │
└────────────────────────────────────────┘
```

**桌面端：** 左右分栏，左侧列表，右侧操作区
**移动端：** 上下分栏，上部操作区，下列表

---

### 5.3 界面适配

**响应式断点：**
- 桌面端：宽度 ≥ 420px
- 移动端：宽度 < 420px

**适配策略：**
- 动态布局切换
- 组件尺寸调整
- 触摸区域优化

---

## 六、数据交互

### 6.1 API 接口

#### 6.1.1 认证接口

**用户登录**
```
POST /api/system/auth/login
请求: { username, password }
响应: { token, userInfo, org, room }
```

**用户登出**
```
POST /api/system/auth/logout
```

**获取 MQTT 配置**
```
GET /api/system/auth/mqtt/info
响应: { host, port, username, password }
```

---

#### 6.1.2 分诊接口

**获取患者列表**
```
GET /api/triage/pat/line/list
参数: { doctorId, deptId }
响应: [{ patId, patName, seqNo, state, ... }]
```

**呼叫患者**
```
POST /api/triage/pat/call
参数: { patId }
响应: { success, message }
```

**患者过号**
```
POST /api/triage/pat/pass
参数: { patId }
响应: { success, message }
```

**患者结诊**
```
POST /api/triage/pat/end
参数: { patId }
响应: { success, message }
```

**医生开诊**
```
POST /api/triage/doc/start
参数: { doctorId }
响应: { success, message }
```

**医生停诊**
```
POST /api/triage/doc/stop
参数: { doctorId }
响应: { success, message }
```

**获取在诊患者**
```
GET /api/triage/doc/visited-patient
参数: { doctorId }
响应: { patId, patName, ... }
```

---

#### 6.1.3 客户端接口

**检查设备注册**
```
GET /api/client/check-device-reg
响应: { registered, error }
```

---

### 6.2 Go 后端接口

**获取应用版本**
```
GetVersion() string
```

**获取呼叫进程端口**
```
GetCallerPort() int
```

**检查呼叫进程状态**
```
IsCallerRunning() bool
```

---

### 6.3 通信机制

#### 6.3.1 HTTP 请求

**请求配置：**
- 基础 URL：通过配置获取
- 超时时间：10 秒
- 认证方式：Bearer Token

**请求头：**
```
Authorization: Bearer {token}
orgid: {机构ID}
orgcode: {机构编码}
orgname: {机构名称}
Content-Type: application/json
```

---

#### 6.3.2 MQTT 消息

**连接流程：**
1. 从后端获取 MQTT 配置
2. 建立 WebSocket 连接
3. 订阅相关主题
4. 处理接收消息

**消息格式：**
```json
{
  "topic": "主题名称",
  "payload": {
    "action": "动作类型",
    "data": "消息数据"
  }
}
```

---

## 七、状态管理

### 7.1 用户状态 (User Store)

**状态字段：**

| 字段 | 类型 | 说明 |
|------|------|------|
| limeToken | string | 登录令牌 |
| userInfo | object | 用户信息 |
| org | object | 机构信息 |
| room | object | 诊室信息 |
| deviceRegistered | boolean | 设备注册状态 |
| deviceError | string | 设备错误信息 |

**持久化：**
- 使用 Pinia PersistedState 插件
- 保存到 localStorage
- 页面刷新后自动恢复

---

### 7.2 患者状态 (Patient Store)

**状态字段：**

| 字段 | 类型 | 说明 |
|------|------|------|
| patients | array | 患者列表 |
| currentPatient | object | 当前选中患者 |
| currentCall | object | 当前呼叫患者 |
| visitPatient | object | 在诊患者 |
| loading | boolean | 加载状态 |
| activeTab | string | 当前标签 |

**计算属性：**
- `waitingCount`: 候诊人数
- `passedCount`: 过号人数
- `endedCount`: 结诊人数

---

### 7.3 MQTT 状态 (MQTT Store)

**状态字段：**

| 字段 | 类型 | 说明 |
|------|------|------|
| connected | boolean | 连接状态 |
| connecting | boolean | 连接中 |
| reconnecting | boolean | 重连中 |
| client | object | MQTT 客户端实例 |
| config | object | 连接配置 |

---

## 八、安全机制

### 8.1 认证安全

**Token 管理：**
- 登录后获取 Token
- 存储在 localStorage
- 每次 HTTP 请求自动携带
- 登出时清除 Token

**Token 过期处理：**
- 检测 Token 过期
- 自动跳转登录页
- 提示重新登录

---

### 8.2 数据安全

**敏感信息保护：**
- 密码加密传输
- Token 安全存储
- 日志脱敏处理

**数据验证：**
- 输入参数校验
- 响应数据验证
- 异常数据处理

---

### 8.3 通信安全

**HTTPS 支持：**
- 支持 HTTPS 通信
- 证书验证
- 加密传输

**MQTT 安全：**
- 用户名密码认证
- TLS 加密连接
- 主题访问控制

---

## 九、性能优化

### 9.1 前端优化

**加载优化：**
- 路由懒加载
- 组件按需加载
- 资源压缩打包

**渲染优化：**
- 虚拟滚动（大列表）
- 防抖节流（频繁操作）
- 计算属性缓存

---

### 9.2 后端优化

**进程管理：**
- 异步启动进程
- 健康检查优化
- 资源占用控制

**日志优化：**
- 异步日志写入
- 日志级别控制
- 日志文件轮转

---

### 9.3 通信优化

**HTTP 优化：**
- 请求合并
- 缓存策略
- 并发控制

**MQTT 优化：**
- 消息批量处理
- 连接池复用
- QoS 级别选择

---

## 十、扩展功能

### 10.1 多窗口支持

**功能描述：**
支持同时运行多个客户端实例，连接不同诊室。

**使用场景：**
- 多诊室同时工作
- 多设备并行操作

---

### 10.2 多语言支持

**设计预留：**
- 文本资源外置
- 多语言切换接口
- 日期时间本地化

---

### 10.3 主题定制

**设计预留：**
- CSS 变量系统
- 主题配置接口
- 用户偏好保存

---

## 十一、系统要求

### 11.1 运行环境

**操作系统：**
- Windows 10/11（推荐）
- macOS 10.15+
- Linux（主流发行版）

**硬件要求：**
- CPU：双核及以上
- 内存：4GB 及以上
- 硬盘：500MB 可用空间

---

### 11.2 依赖服务

**后端服务：**
- suwei_caller_local.exe（必须）
- HTTP API 服务（必须）
- MQTT 服务（必须）

**网络要求：**
- 局域网连接
- 端口开放（API 端口、MQTT 端口）

---

## 十二、常见问题

### 12.1 登录问题

**Q：无法登录系统？**
A：请检查：
1. 账号密码是否正确
2. 网络连接是否正常
3. 后端服务是否运行
4. 设备是否已注册

---

### 12.2 呼叫问题

**Q：呼叫患者无反应？**
A：请检查：
1. 呼叫进程是否运行
2. 音响设备是否正常
3. 患者信息是否正确
4. 网络连接是否稳定

---

### 12.3 连接问题

**Q：MQTT 连接失败？**
A：请检查：
1. MQTT 配置是否正确
2. MQTT 服务是否运行
3. 防火墙是否拦截
4. 网络是否可达

---

### 12.4 性能问题

**Q：系统运行缓慢？**
A：请检查：
1. 患者列表是否过大
2. 网络带宽是否充足
3. 系统资源是否充足
4. 是否有其他程序占用资源

---

## 十三、版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v1.0.0 | 2026-01-07 | 初始版本发布 |

---

## 十四、附录

### 14.1 术语表

| 术语 | 说明 |
|------|------|
| 候诊 | 患者等待就诊的状态 |
| 过号 | 患者错过叫号，需要重新排队 |
| 结诊 | 完成当前患者的就诊 |
| 在诊患者 | 当前正在接受诊疗的患者 |
| 诊室 | 医生办公的物理空间 |
| 分诊 | 将患者分配到诊室的过程 |

---

### 14.2 相关文档

- [开发文档](./开发文档.md)
- [API 文档](./API文档.md)
- [部署指南](./部署指南.md)
- [用户手册](./用户手册.md)

---

### 14.3 联系方式

- 技术支持：[邮箱]
- 问题反馈：[Issue 追踪]
- 官方网站：[网址]

---

**文档结束**
