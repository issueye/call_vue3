# 患者操作功能分析文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档名称 | 患者操作功能深度分析 |
| 文档版本 | v1.0.0 |
| 编写日期 | 2026-01-07 |
| 分析对象 | vue3(old) 目录中的患者操作功能 |
| 分析目标 | 为新版 frontend 功能完善提供参考 |

---

## 一、功能概览

### 1.1 核心功能模块

| 功能名称 | 功能说明 | 业务价值 |
|----------|----------|----------|
| **呼叫患者** | 从排队队列中呼叫下一位患者 | 实现患者就诊流程的启动 |
| **重呼** | 重新呼叫当前在诊患者 | 应对患者未听到呼叫的情况 |
| **下一位** | 处理当前患者后呼叫下一位 | 实现快速连续就诊 |
| **过号** | 将当前患者标记为过号 | 处理患者未按时就诊的情况 |
| **结诊** | 完成当前患者的诊疗 | 结束患者就诊并统计数据 |

### 1.2 功能关系图

```
┌─────────────────────────────────────────────────────────┐
│                   患者就诊流程                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────┐      ┌──────────┐      ┌──────────┐    │
│  │  呼叫    │ ───→ │ 接诊中   │ ───→ │ 结诊/过号│    │
│  └──────────┘      └──────────┘      └──────────┘    │
│       │                                    │           │
│       │           ┌──────────┐            │           │
│       └──────────→│  重呼    │────────────┘           │
│                   └──────────┘                        │
│                                                         │
│  ┌──────────┐      ┌──────────┐      ┌──────────┐    │
│  │  下一位  │ ───→ │ 分诊选择 │ ───→ │ 呼叫下一位│    │
│  └──────────┘      └──────────┘      └──────────┘    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 二、功能详细分析

### 2.1 呼叫患者 (Call Patient)

#### 2.1.1 功能描述

从排队队列中自动获取第一位待诊患者并进行呼叫。

#### 2.1.2 业务流程

```
开始
  │
  ├─→ 检查排队队列是否有患者
  │   │
  │   ├─→ 有患者 ──────────────┐
  │   │                        │
  │   └─→ 无患者 → 显示"无"     │
  │                            │
  ├─→ 构建呼叫参数              │
  │   - appointment_id: ""     │
  │   - dept_id: null          │
  │   - room_id: null          │
  │   - doc_id: 医生ID         │
  │                            │
  ├─→ 调用 API: /triage/patient/call
  │                            │
  ├─→ 接收返回的患者信息        │
  │   - 患者基本信息            │
  │   - 就诊信息                │
  │   - 状态信息                │
  │                            │
  ├─→ 更新当前呼叫患者 (currentCall)
  │                            │
  ├─→ 更新UI显示                │
  │   - 患者姓名                │
  │   - 排队号                  │
  │   - 呼叫次数                │
  │   - 患者状态                │
  │                            │
  └─→ 播放语音提示
```

#### 2.1.3 代码实现

**核心代码位置：** `vue3(old)/src/pages/workbench/composables/useLeft.js` (63-79行)

```javascript
const callPatient = async (type) => {
  const params = {
    appointment_id: "",
    dept_id: null,
    room_id: null,
    doc_id: userStore.userInfo.id,
  };

  const info = await getCallerInstance().apis.triage.apiPatCall(params);

  // 更新当前呼叫患者
  triageStore.setCurrentCall(info.data);

  // 更新UI显示
  updateInfos(info.data);
};
```

#### 2.1.4 API 接口

**接口地址：** `POST /lime/api/v1/ts/triage/patient/call`

**请求参数：**
```javascript
{
  appointment_id: "",        // 预约ID（首次呼叫为空）
  dept_id: null,             // 科室ID
  room_id: null,             // 诊室ID
  doc_id: 123                // 医生ID
}
```

**返回数据：**
```javascript
{
  code: 200,
  data: {
    appointment_id: "123456",
    name: "张三",
    queueNo: "A001",
    line_num: 15,
    call_count: 1,
    state: 0,                // 0=接诊中
    gender: 1,               // 1=男
    age: 35,
    // ... 其他患者信息
  }
}
```

#### 2.1.5 边界条件处理

| 场景 | 处理方式 |
|------|----------|
| 队列为空 | 显示"无"，不调用API |
| 网络错误 | 提示错误信息，保持当前状态 |
| API失败 | 不更新 currentCall，显示错误提示 |
| 重复呼叫 | 通过 loading 状态防止 |

#### 2.1.6 状态变化

```javascript
// 呼叫前
currentCall = {}

// 呼叫后
currentCall = {
  appointment_id: "123456",
  name: "张三",
  queueNo: "A001",
  state: 0,  // 接诊中
  call_count: 1
}
```

---

### 2.2 重呼 (Recall Patient)

#### 2.2.1 功能描述

重新呼叫当前正在就诊的患者，用于患者未听到呼叫或需要提醒的场景。

#### 2.2.2 业务流程

```
开始
  │
  ├─→ 检查是否有当前在诊患者
  │   │
  │   ├─→ 有患者 ──────────────┐
  │   │                        │
  │   └─→ 无患者 → 提示"无在诊患者"
  │                            │
  ├─→ 获取当前患者信息
  │   - appointment_id         │
  │   - 其他基本信息            │
  │                            │
  ├─→ 构建重呼参数
  │   - 使用当前患者的 ID       │
  │                            │
  ├─→ 调用 API: /triage/patient/call
  │                            │
  ├─→ 更新呼叫次数 (call_count++)
  │                            │
  ├─→ 重新播放语音提示
  │                            │
  └─→ 完成
```

#### 2.2.3 代码实现

**核心代码位置：** `vue3(old)/src/pages/workbench/left/components/ui/LeftLg.vue` (14-20行)

```vue
<TButton
  type="recall"
  @click="() => callPatient('recall')"
>
  重新呼叫
</TButton>
```

**调用链：**
```
LeftLg.vue
  └─> callPatient('recall')
       └─> useLeft.js: callPatient(type)
            └─> apiPatCall(params)
```

#### 2.2.4 API 接口

**接口地址：** `POST /lime/api/v1/ts/triage/patient/call`

**请求参数：**
```javascript
{
  appointment_id: "123456",    // 当前患者的预约ID
  dept_id: null,
  room_id: null,
  doc_id: 123
}
```

**返回数据：**
```javascript
{
  code: 200,
  data: {
    appointment_id: "123456",
    call_count: 2,             // 呼叫次数+1
    // ... 其他患者信息（不变）
  }
}
```

#### 2.2.5 边界条件处理

| 场景 | 处理方式 |
|------|----------|
| 无当前患者 | 按钮禁用或提示 |
| 重复点击 | 通过 loading 状态防止 |
| 患者已离开 | 正常重呼，不影响逻辑 |
| 网络错误 | 保持当前状态，提示错误 |

#### 2.2.6 UI 交互设计

**大屏显示：**
```
┌─────────────────────────────────┐
│  [呼叫下一位]  [重新呼叫]  [过号]│
│     蓝色       橙色        红色  │
└─────────────────────────────────┘
```

**小屏显示：**
```
┌──────────────┐
│ [📞] [🔁] [✗]│
│ 呼叫 重呼 过号│
└──────────────┘
```

---

### 2.3 下一位 (Next Patient)

#### 2.3.1 功能描述

处理当前患者后，呼叫下一位患者。如有在诊患者，需要先进行分诊处理（结诊或转诊）。

#### 2.3.2 业务流程

```
开始
  │
  ├─→ 检查是否首次进入
  │   │
  │   ├─→ 首次进入 (currentCall为空)
  │   │   │
  │   │   └─→ 直接呼叫队列第一位
  │   │       └─> callPatient()
  │   │
  │   └─→ 非首次进入 (有currentCall)
  │       │
  │       ├─→ 打开分诊选择弹窗
  │       │   └─> showNextDoctor = true
  │       │
  │       └─→ 获取科室列表
  │           └─> getDeptList()
  │
  ├─→ 分诊选择弹窗
  │   │
  │   ├─→ 显示选项：
  │   │   ├─> 结诊当前患者
  │   │   └─> 转到其他诊室
  │   │
  │   └─→ 用户操作
  │       ├─> 选择"结诊"
  │       │   └─> endServer()
  │       │       ├─> 调用结诊API
  │       │       ├─> 清空currentCall
  │       │       ├─> 提示"结诊成功"
  │       │       └─> 自动呼叫下一位
  │       │
  │       └─> 选择"转诊"
  │           └─> assignRoom(roomId)
  │               ├─> 调用转诊API
  │               ├─> 更新患者诊室
  │               ├─> 从列表移除
  │               └─> 关闭弹窗
  │
  └─→ 完成
```

#### 2.3.3 代码实现

**核心代码位置：** `vue3(old)/src/pages/workbench/composables/useLeft.js` (108-123行)

```javascript
const handleNextClick = async () => {
  // 首次进入直接呼叫
  if ((isFirstEnter && Object.keys(currentCall.value).length == 0) || !currentCall.value) {
    callPatient();
    isFirstEnter = false;
    return;
  }

  // 非首次，先分诊
  showNextDoctor.value = true;
  triageForm.value = currentCall.value;
  await getDeptList();
};
```

**分诊弹窗组件：** `vue3(old)/src/pages/workbench/left/index.vue` (11-73行)

```vue
<el-dialog v-model="showNextDoctor" title="分诊">
  <!-- 结诊按钮 -->
  <el-button @click="endServer">结诊</el-button>

  <!-- 转诊选项 -->
  <el-select v-model="selectedRoom">
    <el-option
      v-for="room in roomList"
      :key="room.id"
      :label="room.name"
      :value="room.id"
    />
  </el-select>

  <!-- 确认转诊 -->
  <el-button @click="assignRoom(selectedRoom)">确认转诊</el-button>
</el-dialog>
```

#### 2.3.4 API 接口

**1. 获取科室列表**
```
GET /lime/api/v1/ts/triage/doctor/qryUntreated
```

**2. 结诊**
```
POST /lime/api/v1/ts/triage/patient/end
```

**3. 转诊**
```
POST /lime/api/v1/ts/triage/patient/move
```

#### 2.3.5 状态管理

```javascript
// 分诊状态
const showNextDoctor = ref(false);     // 是否显示分诊弹窗
const triageForm = ref({});            // 待分诊患者信息
const roomList = ref([]);              // 可选诊室列表
const selectedRoom = ref(null);        // 选中的诊室
const sureLoading = ref(false);        // 操作加载状态

// 首次进入标记
const isFirstEnter = ref(true);
```

#### 2.3.6 边界条件处理

| 场景 | 处理方式 |
|------|----------|
| 首次使用 | 直接呼叫，不显示分诊弹窗 |
| 无在诊患者 | 直接呼叫下一位 |
| 有在诊患者 | 显示分诊选择弹窗 |
| 无可选诊室 | 只显示"结诊"按钮 |
| 转诊失败 | 提示错误，保持弹窗打开 |
| 结诊失败 | 提示错误，保持弹窗打开 |

#### 2.3.7 用户体验优化

**1. 智能判断**
- 首次进入不显示分诊弹窗
- 自动检测是否有在诊患者

**2. 加载状态**
- 按钮显示 loading 动画
- 防止重复提交

**3. 操作反馈**
- 结诊成功提示
- 转诊成功提示
- 自动呼叫下一位

**4. 容错处理**
- 网络错误提示
- 保持弹窗状态
- 可重新操作

---

### 2.4 过号 (Pass Patient)

#### 2.4.1 功能描述

将当前患者标记为过号状态，患者将返回排队队列末尾等待再次呼叫。

#### 2.4.2 业务流程

```
开始
  │
  ├─→ 检查是否有当前在诊患者
  │   │
  │   └─→ 无患者 → 提示"无在诊患者"
  │
  ├─→ 显示确认对话框
  │   内容："确定要将该患者标记为过号吗？"
  │
  ├─→ 用户确认
  │   │
  │   ├─→ 取消 → 关闭对话框
  │   │
  │   └─→ 确认 → 继续处理
  │
  ├─→ 调用过号API
  │   POST /triage/patient/pass
  │   参数: {
  │     appointment_id: "xxx",
  │     doc_id: 123
  │   }
  │
  ├─→ 更新患者状态
  │   state: 0 → 4  (接诊中 → 过号)
  │
  ├─→ 清空当前呼叫
  │   currentCall = {}
  │
  ├─→ 更新UI显示
  │   - 患者信息清空
  │   - 状态标签更新
  │
  ├─→ 提示"过号成功"
  │
  └─→ 自动呼叫下一位（可选）
```

#### 2.4.3 代码实现

**核心代码位置：** `vue3(old)/src/pages/workbench/composables/useLeft.js` (197-210行)

```javascript
const handlePassClick = async () => {
  const params = {
    appointment_id: currentCall.value?.appointment_id,
    dept_id: null,
    room_id: null,
    doc_id: userStore.userInfo.id,
  };

  // 调用过号API
  await getCallerInstance().apis.triage.apiPatPass(params);

  // 重置当前呼叫患者
  triageStore.setCurrentCall({});
  resetInfos();
};
```

#### 2.4.4 API 接口

**接口地址：** `POST /lime/api/v1/ts/triage/patient/pass`

**请求参数：**
```javascript
{
  appointment_id: "123456",    // 当前患者的预约ID
  dept_id: null,
  room_id: null,
  doc_id: 123
}
```

**返回数据：**
```javascript
{
  code: 200,
  message: "过号成功",
  data: {
    appointment_id: "123456",
    state: 4,                  // 状态变为过号
    // ... 其他患者信息
  }
}
```

#### 2.4.5 状态变化

```javascript
// 过号前
currentCall = {
  appointment_id: "123456",
  name: "张三",
  state: 0,                    // 接诊中
  call_count: 2
}

// 过号后
currentCall = {}                // 清空

// 患者在列表中
patient.state = 4              // 变为过号状态
```

#### 2.4.6 边界条件处理

| 场景 | 处理方式 |
|------|----------|
| 无当前患者 | 按钮禁用或提示 |
| 患者已过号 | 不允许重复过号 |
| 网络错误 | 提示错误，保持当前状态 |
| 过号成功 | 清空当前患者，自动呼叫下一位 |
| 队列为空 | 过号后不自动呼叫 |

#### 2.4.7 UI 交互设计

**确认对话框：**
```
┌─────────────────────────────┐
│      确认过号               │
├─────────────────────────────┤
│                             │
│  确定要将患者"张三"标记为过号吗？│
│                             │
│  ┌────────┐  ┌────────┐    │
│  │ 取消   │  │ 确认   │    │
│  └────────┘  └────────┘    │
└─────────────────────────────┘
```

**按钮样式：**
- 大屏：红色按钮"过号"
- 小屏：红色图标按钮
- 悬停效果：加深红色

---

### 2.5 结诊 (End Treatment)

#### 2.5.1 功能描述

完成当前患者的诊疗，将患者状态标记为已结诊，并统计数据。

#### 2.5.2 业务流程

```
开始
  │
  ├─→ 在"下一位"分诊弹窗中
  │
  ├─→ 点击"结诊"按钮
  │
  ├─→ 显示加载状态
  │   sureLoading = true
  │
  ├─→ 调用结诊API
  │   POST /triage/patient/end
  │   参数: {
  │     appointment_id: "xxx",
  │     doc_id: 123
  │   }
  │
  ├─→ API返回
  │   │
  │   ├─→ 成功 (code=200)
  │   │   │
  │   │   ├─> 关闭分诊弹窗
  │   │   │   showNextDoctor = false
  │   │   │
  │   │   ├─> 清空当前呼叫
  │   │   │   currentCall = null
  │   │   │
  │   │   ├─> 重置患者信息
  │   │   │   resetInfos()
  │   │   │
  │   │   ├─> 提示"结诊成功"
  │   │   │   ElMessage.success("结诊成功")
  │   │   │
  │   │   └─> 自动呼叫下一位
  │   │       callPatient()
  │   │
  │   └─→ 失败
  │       │
  │       ├─> 关闭加载状态
  │       │   sureLoading = false
  │       │
  │       └─> 提示错误信息
  │           ElMessage.error(error.message)
  │
  └─→ 完成
```

#### 2.5.3 代码实现

**核心代码位置：** `vue3(old)/src/pages/workbench/composables/useLeft.js` (169-193行)

```javascript
const endServer = async () => {
  try {
    sureLoading.value = true;

    const params = {
      appointment_id: currentCall.value?.appointment_id,
      dept_id: null,
      room_id: null,
      doc_id: userStore.userInfo.id,
    };

    const { code } = await getCallerInstance().apis.triage.apiPatEndServer(params);

    if (code == 200) {
      sureLoading.value = false;
      currentCall.value = null;
      showNextDoctor.value = false;
      ElMessage.success("结诊成功");
      resetInfos();
      callPatient();  // 自动呼叫下一位
    }
  } catch (error) {
    sureLoading.value = false;
    ElMessage.error(error.message);
  }
};
```

#### 2.5.4 API 接口

**接口地址：** `POST /lime/api/v1/ts/triage/patient/end`

**请求参数：**
```javascript
{
  appointment_id: "123456",    // 当前患者的预约ID
  dept_id: null,
  room_id: null,
  doc_id: 123
}
```

**返回数据：**
```javascript
{
  code: 200,
  message: "结诊成功",
  data: {
    appointment_id: "123456",
    state: 99,                 // 状态变为结诊
    end_time: "2026-01-07 14:30:00"
  }
}
```

#### 2.5.5 状态变化

```javascript
// 结诊前
currentCall = {
  appointment_id: "123456",
  name: "张三",
  state: 0,                    // 接诊中
  call_count: 2
}
showNextDoctor = true          // 分诊弹窗打开

// 结诊后
currentCall = null             // 清空
showNextDoctor = false         // 分诊弹窗关闭

// 患者在列表中
patient.state = 99             // 变为结诊状态
```

#### 2.5.6 边界条件处理

| 场景 | 处理方式 |
|------|----------|
| 无当前患者 | 不显示结诊按钮 |
| 结诊失败 | 保持弹窗，可重试 |
| 网络错误 | 关闭loading，提示错误 |
| 队列为空 | 结诊后不自动呼叫 |
| 自动呼叫失败 | 仅提示，不阻塞结诊 |

#### 2.5.7 UI 交互设计

**分诊弹窗中的结诊按钮：**
```
┌─────────────────────────────┐
│      患者分诊               │
├─────────────────────────────┤
│                             │
│  当前患者：张三              │
│                             │
│  ┌─────────────────────┐   │
│  │  转到其他诊室       │   │
│  │  [选择诊室下拉框]   │   │
│  └─────────────────────┘   │
│                             │
│  ┌────────┐  ┌────────┐    │
│  │  结诊  │  │ 确认   │    │
│  └────────┘  └────────┘    │
│                             │
│  [结诊按钮 - 默认主色]      │
└─────────────────────────────┘
```

**加载状态：**
```
┌────────┐
│  结诊  │ ← loading 动画
│  ●●●   │
└────────┘
```

---

## 三、状态管理分析

### 3.1 全局状态

#### 3.1.1 TriageStore（分诊状态）

**文件位置：** `vue3(old)/src/stores/triage.js`

```javascript
export const useTriageStore = defineStore('triage', {
  state: () => ({
    // 当前呼叫的患者
    currentCall: {},

    // 患者列表
    patientList: [],

    // 待诊人数
    waitingCount: 0,

    // 过号人数
    passedCount: 0,

    // 已完成人数
    completedCount: 0,

    // 医生状态
    doctorStatus: {
      status: 1,          // 0=停诊，1=开诊
      wait_count: 0,
      end_count: 0,
      pass_count: 0
    }
  }),

  actions: {
    // 设置当前呼叫患者
    setCurrentCall(patient) {
      this.currentCall = patient;
    },

    // 更新患者列表
    updatePatientList(list) {
      this.patientList = list;
    }
  }
});
```

#### 3.1.2 UserStore（用户状态）

```javascript
export const useUserStore = defineStore('user', {
  state: () => ({
    userInfo: {
      id: 0,
      account: '',
      nick_name: ''
    },

    org: {
      org_id: 0,
      org_code: '',
      org_name: '',
      dept_id: 0
    },

    room: {
      id: 0,
      name: '',
      dept_id: 0
    }
  })
});
```

### 3.2 组件级状态

#### 3.2.1 useLeft Composable

**文件位置：** `vue3(old)/src/pages/workbench/composables/useLeft.js`

```javascript
// 患者信息显示
const infos = reactive({
  roomName: userStore.room.name,
  name: "无",
  status: { title: "", color: "" },
  line_num: "",
  call_count: 0,
  appointment_time: "",
});

// 分诊相关
const showNextDoctor = ref(false);     // 分诊弹窗
const triageForm = ref({});            // 待分诊患者
const roomList = ref([]);              // 诊室列表
const sureLoading = ref(false);        // 操作loading

// 首次进入标记
const isFirstEnter = ref(true);

// 当前呼叫患者
const { currentCall } = storeToRefs(triageStore);
```

### 3.3 状态流转图

```
                    患者状态流转
                        │
        ┌───────────────┼───────────────┐
        │               │               │
    呼叫患者        重呼患者        过号患者
        │               │               │
        ↓               ↓               ↓
   ┌─────┐          ┌─────┐        ┌─────┐
   │候诊中│ ──────→ │接诊中│ ←────── │过号 │
   └─────┘          └─────┘        └─────┘
        │               │               │
        │          ┌────┴────┐          │
        │          │         │          │
        ↓          ↓         ↓          ↓
   ┌────────┐  ┌──────┐  ┌──────┐  ┌──────┐
   │下一位  │  │ 结诊 │  │转诊  │  │重新呼叫│
   └────────┘  └──────┘  └──────┘  └──────┘
        │          │         │          │
        └──────────┴─────────┴──────────┘
                   │
                   ↓
              返回候诊队列
```

---

## 四、UI 交互设计

### 4.1 响应式布局

#### 4.1.1 大屏布局（>420px）

**LeftLg.vue**
```
┌─────────────────────────────────────────┐
│              患者信息卡片               │
├─────────────────────────────────────────┤
│                                         │
│  ┌───────────────────────────────────┐ │
│  │  排队号: A001                      │ │
│  │  姓名: 张三                        │ │
│  │  状态: [接诊中]                    │ │
│  │  呼叫次数: 2次                     │ │
│  └───────────────────────────────────┘ │
│                                         │
│  ┌────────┐ ┌────────┐ ┌────────┐     │
│  │呼叫下一位│ │重新呼叫 │ │ 过号  │     │
│  └────────┘ └────────┘ └────────┘     │
│     蓝色       橙色        红色         │
└─────────────────────────────────────────┘
```

#### 4.1.2 小屏布局（≤420px）

**LeftSm.vue**
```
┌──────────────────┐
│   患者信息卡片   │
├──────────────────┤
│                  │
│  A001 张三       │
│  [接诊中]  2次   │
│                  │
│  [📞] [🔁] [✗]  │
│  呼叫 重呼 过号  │
└──────────────────┘
```

### 4.2 按钮样式规范

#### 4.2.1 颜色规范

| 操作类型 | 主色 | 悬停色 | 文字色 |
|----------|------|--------|--------|
| 呼叫 | #409EFF | #66B1FF | #FFFFFF |
| 重呼 | #E6A23C | #EEBE77 | #FFFFFF |
| 过号 | #F56C6C | #F78989 | #FFFFFF |
| 结诊 | #67C23A | #85CE61 | #FFFFFF |
| 转诊 | #909399 | #A6A9AD | #FFFFFF |

#### 4.2.2 尺寸规范

| 布局 | 按钮高度 | 按钮宽度 | 字体大小 |
|------|----------|----------|----------|
| 大屏 | 40px | 120px | 16px |
| 小屏 | 36px | 36px | - |

#### 4.2.3 交互效果

**悬停效果：**
- 背景色加深 10%
- 轻微放大（scale: 1.05）
- 阴影加强

**点击效果：**
- 涟漪动画
- 按钮缩小（scale: 0.95）
- 快速恢复

**禁用状态：**
- 透明度 50%
- 鼠标变为 not-allowed
- 无交互效果

### 4.3 弹窗设计

#### 4.3.1 分诊弹窗

```
┌─────────────────────────────────┐
│         患者分诊        [×]     │
├─────────────────────────────────┤
│                                 │
│  当前患者：张三 (A001)           │
│                                 │
│  请选择处理方式：                │
│                                 │
│  ┌───────────────────────────┐ │
│  │  转到其他诊室             │ │
│  │  ┌─────────────────────┐ │ │
│  │  │ [请选择诊室 ↓]      │ │ │
│  │  └─────────────────────┘ │ │
│  │                           │ │
│  │  可选诊室：               │ │
│  │  • 诊室A                  │ │
│  │  • 诊室B                  │ │
│  │  • 诊室C                  │ │
│  └───────────────────────────┘ │
│                                 │
│  ┌──────────┐  ┌──────────┐    │
│  │   结诊   │  │   确认   │    │
│  └──────────┘  └──────────┘    │
│                                 │
└─────────────────────────────────┘
```

#### 4.3.2 确认对话框

```
┌─────────────────────────────────┐
│         确认操作                │
├─────────────────────────────────┤
│                                 │
│        ⚠️ 图标                  │
│                                 │
│  确定要将患者"张三"标记为过号吗？ │
│                                 │
│  ┌────────┐  ┌────────┐        │
│  │  取消  │  │  确认  │        │
│  └────────┘  └────────┘        │
│                                 │
└─────────────────────────────────┘
```

### 4.4 加载状态

#### 4.4.1 按钮加载

```
┌────────────────┐
│  结诊  ●●●     │ ← loading
└────────────────┘
```

#### 4.4.2 全屏加载

```
┌─────────────────────────┐
│                         │
│         🔄 图标          │
│                         │
│      正在处理中...       │
│                         │
└─────────────────────────┘
```

---

## 五、数据同步机制

### 5.1 MQTT 实时同步

#### 5.1.1 订阅主题

```javascript
// 医生状态同步
`${orgCode}/doctor/status`

// 患者信息更新
`${orgCode}/department/${deptId}/patient/update`
```

#### 5.1.2 消息处理

```javascript
// mqtt.js
mqtt.on('message', (topic, message) => {
  const data = JSON.parse(message.toString());

  // 医生状态更新
  if (topic.includes('/doctor/status')) {
    triageStore.setDoctorStatus(data);
  }

  // 患者信息更新
  if (topic.includes('/patient/update')) {
    triageStore.updatePatient(data);
  }
});
```

### 5.2 状态同步流程

```
┌─────────────┐     操作      ┌─────────────┐
│   前端UI    │ ───────────→ │   API层     │
└─────────────┘              └─────────────┘
      ↑                            │
      │                            ↓
      │                    ┌─────────────┐
      │                    │  后端服务   │
      │                    └─────────────┘
      │                            │
      │                            ↓
      │                    ┌─────────────┐
      │                    │   数据库    │
      │                    └─────────────┘
      │                            │
      │                            ↓
      │                    ┌─────────────┐
      │                    │ MQTT Broker │
      │                    └─────────────┘
      │                            │
      └────────────────────────────┘
              推送状态更新
```

### 5.3 并发控制

#### 5.3.1 防止重复提交

```javascript
const loading = ref(false);

const handleCall = async () => {
  if (loading.value) return;  // 防止重复提交

  loading.value = true;
  try {
    await apiCall();
  } finally {
    loading.value = false;
  }
};
```

#### 5.3.2 操作队列

```javascript
const operationQueue = [];

const enqueue = (operation) => {
  operationQueue.push(operation);
  processQueue();
};

const processQueue = async () => {
  while (operationQueue.length > 0) {
    const operation = operationQueue.shift();
    await operation();
  }
};
```

---

## 六、错误处理机制

### 6.1 网络错误

#### 6.1.1 超时处理

```javascript
const callWithTimeout = (api, params, timeout = 10000) => {
  return Promise.race([
    api(params),
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error('请求超时')), timeout)
    )
  ]);
};
```

#### 6.1.2 重试机制

```javascript
const retry = async (fn, times = 3) => {
  for (let i = 0; i < times; i++) {
    try {
      return await fn();
    } catch (error) {
      if (i === times - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
  }
};
```

### 6.2 业务错误

#### 6.2.1 错误码处理

```javascript
const errorMap = {
  400: '请求参数错误',
  401: '未授权，请重新登录',
  403: '无权限操作',
  404: '资源不存在',
  500: '服务器错误',
  1001: '队列为空',
  1002: '患者不存在',
  1003: '已被其他医生呼叫'
};

const handleError = (code) => {
  const message = errorMap[code] || '未知错误';
  ElMessage.error(message);
};
```

#### 6.2.2 用户提示

```javascript
// 成功提示
ElMessage.success('操作成功');

// 错误提示
ElMessage.error('操作失败：' + error.message);

// 警告提示
ElMessage.warning('请注意：该操作不可撤销');

// 信息提示
ElMessage.info('正在处理中...');
```

### 6.3 日志记录

```javascript
const logger = {
  info: (message, data) => {
    console.log(`[INFO] ${message}`, data);
  },

  error: (message, error) => {
    console.error(`[ERROR] ${message}`, error);
  },

  warn: (message, data) => {
    console.warn(`[WARN] ${message}`, data);
  }
};

// 使用
logger.info('呼叫患者', { patientId: '123' });
logger.error('呼叫失败', error);
```

---

## 七、性能优化

### 7.1 请求优化

#### 7.1.1 请求合并

```javascript
// 合并多个请求
const fetchAllData = async () => {
  const [patients, status, rooms] = await Promise.all([
    apiGetPatients(),
    apiGetStatus(),
    apiGetRooms()
  ]);

  return { patients, status, rooms };
};
```

#### 7.1.2 请求缓存

```javascript
const cache = new Map();

const cachedFetch = async (key, fetcher, ttl = 60000) => {
  const cached = cache.get(key);

  if (cached && Date.now() - cached.time < ttl) {
    return cached.data;
  }

  const data = await fetcher();
  cache.set(key, { data, time: Date.now() });

  return data;
};
```

### 7.2 渲染优化

#### 7.2.1 虚拟滚动

```javascript
// 对于长列表使用虚拟滚动
import { VirtualList } from 'vue-virtual-scroll-list';

<VirtualList
  :data-sources="patients"
  :data-key="'id'"
  :keeps="30"
>
  <template #item="{ item }">
    <PatientItem :patient="item" />
  </template>
</VirtualList>
```

#### 7.2.2 防抖节流

```javascript
// 防抖
import { debounce } from 'lodash-es';

const handleSearch = debounce((keyword) => {
  searchPatients(keyword);
}, 300);

// 节流
import { throttle } from 'lodash-es';

const handleScroll = throttle(() => {
  loadMore();
}, 1000);
```

---

## 八、安全性考虑

### 8.1 权限验证

```javascript
// 检查医生权限
const checkPermission = () => {
  if (!userStore.userInfo?.id) {
    ElMessage.error('未登录或登录已过期');
    router.push('/login');
    return false;
  }

  if (userStore.doctorStatus?.status !== 1) {
    ElMessage.warning('您当前处于停诊状态');
    return false;
  }

  return true;
};

// 在操作前检查
const handleCall = async () => {
  if (!checkPermission()) return;

  await apiCall();
};
```

### 8.2 数据验证

```javascript
// 参数验证
const validateParams = (params) => {
  const required = ['doc_id'];

  for (const field of required) {
    if (!params[field]) {
      throw new Error(`${field} 不能为空`);
    }
  }

  return true;
};

// 使用
const callPatient = async () => {
  const params = { doc_id: userStore.userInfo.id };

  if (!validateParams(params)) {
    return;
  }

  await apiCall(params);
};
```

### 8.3 操作确认

```javascript
// 危险操作二次确认
const confirmDangerous = async (message, callback) => {
  try {
    await ElMessageBox.confirm(
      message,
      '确认操作',
      {
        confirmButtonText: '确认',
        cancelButtonText: '取消',
        type: 'warning'
      }
    );

    await callback();
  } catch {
    // 用户取消
  }
};

// 使用
const handlePass = () => {
  confirmDangerous('确定要将该患者标记为过号吗？', async () => {
    await apiPass();
  });
};
```

---

## 九、测试要点

### 9.1 功能测试

| 测试项 | 测试内容 | 预期结果 |
|--------|----------|----------|
| 呼叫患者 | 点击呼叫按钮 | 成功呼叫第一位患者 |
| 重呼 | 点击重呼按钮 | 重新呼叫当前患者，计数+1 |
| 下一位（首次） | 首次点击下一位 | 直接呼叫，不显示分诊 |
| 下一位（有在诊） | 有在诊患者时点击下一位 | 显示分诊弹窗 |
| 结诊 | 在分诊弹窗点击结诊 | 结诊成功，自动呼叫下一位 |
| 过号 | 点击过号按钮 | 患者状态变为过号 |
| 转诊 | 选择其他诊室并确认 | 转诊成功，从列表移除 |

### 9.2 边界测试

| 测试项 | 测试场景 | 预期结果 |
|--------|----------|----------|
| 空队列 | 队列无患者时呼叫 | 提示"暂无患者" |
| 重复操作 | 快速重复点击按钮 | 只执行一次 |
| 网络断开 | 断网时进行操作 | 提示网络错误 |
| 超时 | API请求超时 | 提示请求超时 |
| 并发 | 多个医生同时呼叫 | 正常处理，不冲突 |

### 9.3 UI 测试

| 测试项 | 测试内容 | 预期结果 |
|--------|----------|----------|
| 响应式 | 不同屏幕尺寸 | 正常显示，无错位 |
| 按钮状态 | 不同操作状态 | 颜色、图标正确 |
| 弹窗 | 打开/关闭弹窗 | 动画流畅，无卡顿 |
| 加载状态 | 操作进行中 | 显示loading，禁用按钮 |

---

## 十、总结与建议

### 10.1 功能特点

✅ **优点：**
1. 业务流程完整，覆盖所有就诊场景
2. 响应式设计，适配多种屏幕尺寸
3. 状态管理清晰，数据流向明确
4. 错误处理完善，用户体验友好
5. MQTT实时同步，数据及时更新

⚠️ **可优化点：**
1. 部分功能可进一步抽象为可复用Hook
2. 可增加更多的用户操作引导
3. 可优化错误提示的友好度
4. 可增加操作撤销功能

### 10.2 新版实现建议

#### 10.2.1 架构优化

```javascript
// 建议的目录结构
src/
  composables/
    usePatientCall.js        // 患者呼叫逻辑
    usePatientRecall.js      // 重呼逻辑
    usePatientPass.js        // 过号逻辑
    usePatientNext.js        // 下一位逻辑
    usePatientEnd.js         // 结诊逻辑

  components/
    business/
      CallButtons.vue        // 呼叫按钮组
      TriageDialog.vue       // 分诊弹窗
      PatientCard.vue        // 患者卡片

  stores/
    patient.js               // 患者状态
    ui.js                    // UI状态
```

#### 10.2.2 功能增强

1. **快捷键支持**
   - 空格：呼叫
   - R：重呼
   - N：下一位
   - P：过号
   - E：结诊

2. **语音播报**
   - 自动播报患者姓名
   - 播报诊室信息
   - 可配置播报语言

3. **操作历史**
   - 记录操作日志
   - 支持撤销操作
   - 统计操作数据

4. **批量操作**
   - 批量过号
   - 批量转诊
   - 批量结诊

#### 10.2.3 用户体验优化

1. **智能提示**
   - 首次使用引导
   - 操作提示
   - 错误提示优化

2. **个性化配置**
   - 按钮布局自定义
   - 快捷键自定义
   - 主题颜色自定义

3. **无障碍支持**
   - 键盘导航
   - 屏幕阅读器支持
   - 高对比度模式

---

## 附录

### A. 患者状态码表

| 状态码 | 名称 | 说明 | 颜色 |
|--------|------|------|------|
| 0 | 接诊中 | 正在就诊中 | 蓝色 |
| 1 | 优先 | 优先就诊 | 绿色 |
| 2 | 候诊中 | 等待就诊 | 青色 |
| 3 | 复诊 | 复诊患者 | 橙色 |
| 4 | 过号 | 已过号 | 红色 |
| 99 | 结诊 | 已完成 | 灰色 |

### B. API 接口汇总

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 呼叫患者 | POST | /triage/patient/call | 呼叫或重呼患者 |
| 过号 | POST | /triage/patient/pass | 标记患者过号 |
| 结诊 | POST | /triage/patient/end | 完成患者诊疗 |
| 获取列表 | GET | /triage/patient/list | 获取患者列表 |
| 获取科室 | GET | /triage/doctor/rooms | 获取可转诊科室 |
| 分配诊室 | POST | /triage/patient/move | 分配患者到诊室 |
| 医生开诊 | POST | /triage/doctor/start | 医生开始接诊 |
| 医生停诊 | POST | /triage/doctor/stop | 医生停止接诊 |

### C. 相关文件清单

```
vue3(old)/src/
├── pages/workbench/
│   ├── left/
│   │   ├── index.vue                 # 左侧主组件
│   │   └── components/
│   │       └── ui/
│   │           ├── LeftLg.vue        # 大屏布局
│   │           └── LeftSm.vue        # 小屏布局
│   └── composables/
│       └── useLeft.js                # 业务逻辑Hook
├── stores/
│   └── triage.js                     # 分诊状态管理
├── mqtt/
│   └── mqtt.js                       # MQTT客户端
└── utils/
    └── caller.js                     # API调用封装
```

---

**文档结束**
