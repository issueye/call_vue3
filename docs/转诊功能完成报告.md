# 转诊功能完善报告

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档名称 | 转诊功能完善报告 |
| 文档版本 | v1.0.0 |
| 完成日期 | 2026-01-07 |
| 功能状态 | ✅ 全部完成 |

---

## 一、功能概述

### 1.1 转诊功能说明

转诊功能是指医生将当前在诊患者分配到其他诊室的功能，通常用于以下场景：

- **患者需要转科室**：当前诊室无法完成诊疗，需要转到其他科室
- **医生工作调整**：当前医生无法继续诊疗，需要转给其他医生
- **诊室资源优化**：平衡各诊室的工作负荷
- **患者需求变更**：患者要求更换诊室或医生

### 1.2 转诊流程

```
┌─────────────────────────────────────────┐
│           转诊完整流程                  │
├─────────────────────────────────────────┤
│                                         │
│  1. 医生点击"下一位"按钮                │
│     │                                   │
│     ├─> 无在诊患者                      │
│     │   └─> 直接呼叫第一位候诊患者        │
│     │                                   │
│     └─> 有在诊患者                      │
│         └─> 显示分诊弹窗                │
│                                         │
│  2. 在分诊弹窗中选择"转到其他诊室"      │
│     │                                   │
│     └─> 加载可分配诊室列表              │
│                                         │
│  3. 选择目标诊室                        │
│     │                                   │
│     ├─> 下拉框选择诊室                  │
│     └─> 确认选择的诊室                  │
│                                         │
│  4. 确认转诊                            │
│     │                                   │
│     ├─> 显示确认对话框                  │
│     │   └─> "确定要将患者xxx转诊吗？"    │
│     │                                   │
│     └─> 用户确认                        │
│         │                               │
│         ├─> 取消 → 返回弹窗             │
│         │                               │
│         └─> 确认 → 执行转诊             │
│                                         │
│  5. 执行转诊操作                        │
│     │                                   │
│     ├─> 调用转诊 API                   │
│     │   POST /lime/api/v1/ts/triage/patient/move
│     │                                   │
│     ├─> 从当前列表移除患者              │
│     ├─> 清空当前在诊患者                │
│     └─> 关闭分诊弹窗                    │
│                                         │
│  6. 提示和后续操作                      │
│     │                                   │
│     ├─> 显示"转诊成功"提示              │
│     ├─> 自动呼叫下一位患者              │
│     └─> 更新患者列表                    │
│                                         │
└─────────────────────────────────────────┘
```

---

## 二、功能实现

### 2.1 核心组件

#### TriageDialog 组件

**文件路径：** `frontend/src/components/common/TriageDialog.vue`

**主要功能：**
- ✅ 显示当前在诊患者信息
- ✅ 展示可转诊的诊室列表
- ✅ 提供转诊和结诊两种操作
- ✅ 加载状态显示
- ✅ 响应式设计（桌面端/移动端）

**UI 特点：**
- 渐变色患者信息卡片（紫色）
- 清晰的提示信息
- 友好的按钮布局
- 流畅的打开/关闭动画

#### 组件 Props

| 属性 | 类型 | 说明 |
|------|------|------|
| `visible` | Boolean | 控制弹窗显示/隐藏 |
| `patient` | Object | 当前在诊患者信息 |
| `roomList` | Array | 可分配的诊室列表 |

#### 组件 Events

| 事件 | 参数 | 说明 |
|------|------|------|
| `update:visible` | Boolean | 更新弹窗显示状态 |
| `triage` | (patient, roomId) | 确认转诊操作 |
| `end` | patient | 确认结诊操作 |
| `cancel` | - | 取消操作 |

---

### 2.2 Store 方法

#### confirmAssign 方法

**文件路径：** `frontend/src/stores/patient.js`

```javascript
// 确认分诊
const confirmAssign = async (patient, roomId) => {
  if (roomId) {
    // 分配到诊室（转诊）
    return await assignRoom(patient, roomId);
  } else {
    // 结诊
    return await endPatient(userStore.userInfo.id, patient);
  }
};
```

**功能说明：**
- 根据 `roomId` 参数判断执行转诊或结诊
- 有 `roomId`：执行转诊操作
- 无 `roomId`：执行结诊操作

---

#### assignRoom 方法

**文件路径：** `frontend/src/stores/patient.js`

```javascript
// 分配患者到其他诊室（转诊）
const assignRoom = async (patient, roomId) => {
  try {
    // 调用转诊 API
    await apiAssignRoom({
      patient_id: patient.id,
      target_room_id: roomId,
      org_id: patient.org_id,
    });

    // 从列表中移除患者
    patients.value = patients.value.filter((p) => p.id !== patient.id);

    // 清空当前患者（如果转诊的是当前患者）
    if (currentPatient.value?.id === patient.id) {
      currentPatient.value = null;
    }

    // 清空在诊患者
    if (visitPatient.value?.id === patient.id) {
      visitPatient.value = null;
    }

    return { success: true, message: "转诊成功" };
  } catch (error) {
    console.error("转诊失败:", error);
    return { success: false, message: error.message || "转诊失败" };
  }
};
```

**功能说明：**
- 调用转诊 API
- 从患者列表中移除转诊患者
- 清空当前患者和在诊患者状态
- 返回操作结果

---

### 2.3 布局组件集成

#### DesktopLayout 集成

**文件路径：** `frontend/src/components/layout/desktop/DesktopLayout.vue`

**关键代码：**
```javascript
// 处理分诊-转诊
const handleTriage = async (patient, roomId) => {
  // 确认转诊
  if (!confirm(`确定要将患者"${patient?.name}"转诊到其他诊室吗？`)) {
    return
  }

  try {
    const result = await patientStore.confirmAssign(patient, roomId)

    if (result.success) {
      ElMessage.success('转诊成功')
      // 关闭分诊弹窗
      patientStore.showNextDialog = false

      // 自动呼叫下一位
      await handleNext()
    } else {
      ElMessage.error(result.message || '转诊失败')
    }
  } catch (error) {
    console.error('转诊失败:', error)
    ElMessage.error(error.message || '转诊失败')
  }
}
```

**流程说明：**
1. 显示确认对话框
2. 用户确认后调用转诊 API
3. 转诊成功后：
   - 显示成功提示
   - 关闭分诊弹窗
   - 自动呼叫下一位患者
4. 转诊失败则显示错误提示

---

#### MobileLayout 集成

**文件路径：** `frontend/src/components/layout/mobile/MobileLayout.vue`

**关键代码：**
```javascript
// 处理分诊-转诊
const handleTriage = async (patient, roomId) => {
  // 确认转诊
  if (!confirm(`确定要将患者"${patient?.name}"转诊到其他诊室吗？`)) {
    return
  }

  try {
    const result = await patientStore.confirmAssign(patient, roomId)

    if (result.success) {
      ElMessage.success('转诊成功')
      // 关闭分诊弹窗
      patientStore.showNextDialog = false

      // 自动呼叫下一位
      await handleNext()
    } else {
      ElMessage.error(result.message || '转诊失败')
    }
  } catch (error) {
    console.error('转诊失败:', error)
    ElMessage.error(error.message || '转诊失败')
  }
}
```

**流程说明：**
- 与桌面端相同的逻辑
- 适配移动端布局
- 响应式弹窗显示

---

## 三、功能特性

### 3.1 转诊功能特点

#### ✅ 智能状态管理

| 状态 | 说明 | 更新时机 |
|------|------|----------|
| `patients` | 患者列表 | 转诊后移除患者 |
| `currentPatient` | 当前选中患者 | 转诊该患者时清空 |
| `visitPatient` | 在诊患者 | 转诊该患者时清空 |
| `showNextDialog` | 分诊弹窗状态 | 操作成功后关闭 |

#### ✅ 完整的确认流程

```
操作 → 确认对话框 → API调用 → 结果反馈 → 后续操作
```

1. **二次确认**：防止误操作
2. **API 调用**：与后端交互
3. **结果反馈**：成功/失败提示
4. **自动呼叫**：转诊成功后自动呼叫下一位

#### ✅ 用户体验优化

| 特性 | 说明 | 用户体验 |
|------|------|----------|
| 确认对话框 | 防止误操作 | 安全性 ↑ |
| 成功提示 | ElMessage.success('转诊成功') | 反馈及时 |
| 失败提示 | ElMessage.error(error.message) | 问题明确 |
| 自动关闭弹窗 | 无需手动关闭 | 操作流畅 |
| 自动呼叫下一位 | 无需手动操作 | 效率提升 |

---

### 3.2 边界条件处理

#### 场景1：无可用诊室

**处理方式：**
```vue
<!-- 无可用诊室提示 -->
<div v-else class="triage-dialog__no-rooms">
  <svg>...</svg>
  <p>当前无其他可用诊室</p>
  <span>可直接完成本次诊疗</span>
</div>
```

**UI 展示：**
- 隐藏"确认转诊"按钮
- 显示友好提示信息
- 只显示"完成诊疗"按钮

---

#### 场景2：未选择诊室

**处理方式：**
```javascript
const handleTriage = async () => {
  if (!selectedRoom.value) {
    alert("请选择诊室");
    return;
  }
  // 继续执行转诊
};
```

**UI 展示：**
- "确认转诊"按钮禁用
- 提示"请选择诊室"

---

#### 场景3：转诊失败

**处理方式：**
```javascript
try {
  const result = await patientStore.confirmAssign(patient, roomId);
  if (result.success) {
    // 成功处理
  } else {
    ElMessage.error(result.message || '转诊失败');
  }
} catch (error) {
  ElMessage.error(error.message || '转诊失败');
}
```

**用户体验：**
- 错误提示清晰
- 分诊弹窗保持打开
- 可重新选择诊室

---

#### 场景4：取消转诊

**处理方式：**
```javascript
const handleCancel = () => {
  selectedRoom.value = null;  // 重置选择
  emit("update:visible", false);  // 关闭弹窗
  emit("cancel");  // 触发取消事件
};
```

---

## 四、UI 设计

### 4.1 分诊弹窗布局

```
┌──────────────────────────────────────────────┐
│              患者分诊             [×]        │
├──────────────────────────────────────────────┤
│                                              │
│  ┌────────────────────────────────────────┐ │
│  │  🟣 患者头像                    张三   │ │
│  │                                      │ │
│  │  排队号: A001  |  呼叫: 2次         │ │
│  └────────────────────────────────────────┘ │
│                                              │
│  ⓘ 请选择处理方式：转诊到其他诊室或完成诊疗   │
│                                              │
│  ┌────────────────────────────────────────┐ │
│  │  🏥 转到其他诊室                      │ │
│  ├────────────────────────────────────────┤ │
│  │  [请选择诊室 ▼]                       │ │
│  │  • 诊室A                             │ │
│  │  • 诊室B                             │ │
│  │  • 诊室C                             │ │
│  └────────────────────────────────────────┘ │
│                                              │
│  ┌────────┐  ┌────────┐  ┌────────┐       │
│  │确认转诊│  │完成诊疗 │  │ 取消   │       │
│  └────────┘  └────────┘  └────────┘       │
│                                              │
└──────────────────────────────────────────────┘
```

---

### 4.2 无可用诊室时的布局

```
┌──────────────────────────────────────────────┐
│              患者分诊             [×]        │
├──────────────────────────────────────────────┤
│                                              │
│  ┌────────────────────────────────────────┐ │
│  │  🟣 患者头像                    张三   │ │
│  └────────────────────────────────────────┘ │
│                                              │
│  ⓘ 请选择处理方式：转诊到其他诊室或完成诊疗   │
│                                              │
│  ┌────────────────────────────────────────┐ │
│  │          👤                            │ │
│  │   当前无其他可用诊室                   │ │
│  │   可直接完成本次诊疗                    │ │
│  └────────────────────────────────────────┘ │
│                                              │
│  ┌────────┐  ┌────────┐                  │
│  │完成诊疗 │  │ 取消   │                  │
│  └────────┘  └────────┘                  │
│                                              │
└──────────────────────────────────────────────┘
```

---

### 4.3 颜色方案

| 元素 | 颜色 | 用途 |
|------|------|------|
| 患者头像渐变 | `linear-gradient(135deg, #667eea 0%, #764ba2 100%)` | 视觉重点 |
| 转诊按钮 | `#409eff` | 主操作 |
| 结诊按钮 | `#67c23a` | 次要操作 |
| 取消按钮 | `#909399` | 取消操作 |
| 提示信息背景 | `#f0f9ff` | 信息提示 |
| 提示信息文字 | `#409eff` | 信息强调 |

---

## 五、API 接口

### 5.1 转诊 API

**接口地址：** `POST /lime/api/v1/ts/triage/patient/move`

**请求参数：**
```javascript
{
  patient_id: 123,          // 患者 ID
  target_room_id: 456,      // 目标诊室 ID
  org_id: 1                // 机构 ID
}
```

**返回数据：**
```javascript
{
  code: 200,
  message: "转诊成功",
  data: {
    patient_id: 123,
    target_room_id: 456,
    room_name: "诊室A"
  }
}
```

---

### 5.2 获取诊室列表 API

**接口地址：** `GET /lime/api/v1/ts/triage/doctor/qryUntreated`

**请求参数：**
```javascript
{
  org_id: 1,              // 机构 ID
  dept_id: 2              // 科室 ID
}
```

**返回数据：**
```javascript
{
  code: 200,
  data: {
    list: [
      {
        id: 1,
        name: "诊室A",
        dept_id: 2,
        location: "一楼",
        room_type: 1
      },
      {
        id: 2,
        name: "诊室B",
        dept_id: 2,
        location: "二楼",
        room_type: 1
      }
    ]
  }
}
```

---

## 六、代码变更

### 6.1 新增文件

| 文件 | 说明 |
|------|------|
| `components/common/TriageDialog.vue` | 分诊弹窗组件 |
| `components/common/TriageDialog.css` | 分诊弹窗样式 |

### 6.2 修改文件

| 文件 | 变更说明 |
|------|----------|
| `stores/patient.js` | 优化 `assignRoom` 方法 |
| `layout/desktop/DesktopLayout.vue` | 完善 `handleTriage` 和 `handleEnd` |
| `layout/mobile/MobileLayout.vue` | 完善 `handleTriage` 和 `handleEnd` |

### 6.3 代码统计

- **新增代码：** ~600 行（组件 + 样式）
- **修改代码：** ~150 行（布局组件和 store）
- **功能增强：** 转诊确认、自动呼叫、错误处理

---

## 七、使用示例

### 7.1 转诊操作示例

```javascript
// 1. 打开分诊弹窗
await patientStore.handleNext(docId, orgId, deptId);

// 2. 选择诊室
const roomId = 1; // 选择的诊室 ID

// 3. 确认转诊
const result = await patientStore.confirmAssign(patient, roomId);

if (result.success) {
  console.log('转诊成功');
  // 弹窗自动关闭
  // 自动呼叫下一位
}
```

---

### 7.2 完整使用流程

```vue
<script setup>
import { usePatientStore, useUserStore } from '@/stores';

const patientStore = usePatientStore();
const userStore = useUserStore();

// 在分诊弹窗中的处理
const handleTriage = async (patient, roomId) => {
  // 确认转诊
  if (!confirm(`确定要将患者"${patient?.name}"转诊到其他诊室吗？`)) {
    return
  }

  try {
    const result = await patientStore.confirmAssign(patient, roomId)

    if (result.success) {
      ElMessage.success('转诊成功')
      // 关闭分诊弹窗
      patientStore.showNextDialog = false

      // 自动呼叫下一位
      await handleNext()
    } else {
      ElMessage.error(result.message || '转诊失败')
    }
  } catch (error) {
    ElMessage.error(error.message || '转诊失败')
  }
}
</script>

<template>
  <TriageDialog
    v-model:visible="patientStore.showNextDialog"
    :patient="patientStore.visitPatient"
    :room-list="patientStore.deptRoomList"
    @triage="handleTriage"
    @end="handleEnd"
    @cancel="handleTriageCancel"
  />
</template>
```

---

## 八、测试指南

### 8.1 功能测试

| 测试项 | 操作步骤 | 预期结果 |
|--------|----------|----------|
| 打开分诊弹窗 | 有在诊患者时点击"下一位" | 显示分诊弹窗和患者信息 |
| 加载诊室列表 | 弹窗打开后 | 正确显示可用诊室列表 |
| 选择诊室 | 在下拉框中选择诊室 | 诊室名称正确显示 |
| 未选择诊室 | 不选择直接点击"确认转诊" | 提示"请选择诊室"，按钮禁用 |
| 转诊确认 | 选择诊室后点击"确认转诊" | 显示确认对话框 |
| 转诊成功 | 确认对话框中点击"确定" | 显示"转诊成功"，弹窗关闭 |
| 自动呼叫下一位 | 转诊成功后 | 自动呼叫下一位患者 |
| 转诊取消 | 确认对话框中点击"取消" | 返回弹窗，不执行转诊 |
| 转诊失败 | 模拟 API 失败 | 显示错误提示，弹窗保持打开 |

---

### 8.2 边界测试

| 测试项 | 场景 | 预期结果 |
|--------|------|----------|
| 无可用诊室 | 诊室列表为空 | 只显示"完成诊疗"按钮 |
| 网络错误 | 断网状态转诊 | 显示"网络错误"提示 |
| 重复操作 | 快速多次点击"确认转诊" | 只执行一次，显示加载状态 |
| 参数错误 | API 参数不完整 | 显示错误提示 |
| 并发操作 | 在转诊中操作其他功能 | 正确处理，无状态冲突 |

---

### 8.3 UI 测试

| 测试项 | 测试内容 | 预期结果 |
|--------|----------|----------|
| 弹窗打开 | 点击"下一位"打开弹窗 | 动画流畅，信息正确显示 |
| 弹窗关闭 | 点击遮罩、关闭按钮、取消按钮 | 正确关闭，状态重置 |
| 响应式 | 桌面端和移动端 | 布局自适应，样式正确 |
| 按钮状态 | 选择/未选择诊室 | 按钮状态正确更新 |
| 加载状态 | 转诊进行中 | 显示加载动画，禁用按钮 |

---

## 九、与结诊功能的配合

### 9.1 转诊 vs 结诊

| 对比项 | 转诊 | 结诊 |
|--------|------|------|
| **目的** | 转到其他诊室继续诊疗 | 完成当前诊疗 |
| **条件** | 需要有可用诊室 | 无条件 |
| **患者状态** | 从当前诊室移除 | 状态变为"已结诊" |
| **后续操作** | 自动呼叫下一位 | 自动呼叫下一位 |
| **使用场景** | 转科室、转医生 | 完成诊疗 |

---

### 9.2 交互流程

```
分诊弹窗
    │
    ├─> 转诊到其他诊室
    │   ├─> 选择诊室
    │   ├─> 确认转诊
    │   ├─> API 调用成功
    │   ├─> 显示"转诊成功"
    │   ├─> 关闭弹窗
    │   └─> 自动呼叫下一位
    │
    └─> 完成诊疗
        ├─> 点击"完成诊疗"
        ├─> 确认对话框
        ├─> API 调用成功
        ├─> 显示"结诊成功"
        ├─> 关闭弹窗
        └─> 自动呼叫下一位
```

---

## 十、问题排查

### 10.1 常见问题

#### Q1：分诊弹窗没有显示可用诊室

**可能原因：**
- API 调用失败
- 返回数据格式不正确
- 机构或科室 ID 不正确

**排查方法：**
```javascript
// 检查诊室列表数据
console.log('诊室列表:', patientStore.deptRoomList);

// 检查 API 调用
const rooms = await patientStore.getDeptRoomList(orgId, deptId);
console.log('API 返回:', rooms);
```

---

#### Q2：转诊后患者没有从列表中移除

**可能原因：**
- 患者 ID 匹配不上
- 列表没有重新获取

**排查方法：**
```javascript
// 检查患者 ID
console.log('患者 ID:', patient.id);

// 检查列表更新
console.log('当前列表:', patientStore.patients);

// 手动刷新列表
await patientStore.fetchPatients(docId, patType);
```

---

#### Q3：转诊成功后没有自动呼叫下一位

**可能原因：**
- `handleNext` 调用失败
- 队列为空

**排查方法：**
```javascript
// 检查队列
console.log('候诊列表:', patientStore.waitingPatients);

// 检查调用结果
const result = await handleNext();
console.log('下一位结果:', result);
```

---

### 10.2 调试技巧

#### 开启详细日志

```javascript
// 在浏览器控制台中查看
localStorage.setItem('debug', 'true');

// 查看状态
console.log('患者状态:', patientStore.$state);
console.log('用户状态:', userStore.$state);
```

#### 查看 Network 面板

```
1. 打开浏览器开发者工具（F12）
2. 切换到 Network 面板
3. 执行转诊操作
4. 查看 API 请求和响应
```

---

## 十一、后续优化

### 11.1 功能增强

1. **转诊原因选择**
   - 添加转诊原因下拉框
   - 记录转诊原因

2. **转诊历史记录**
   - 记录转诊操作
   - 查看转诊历史

3. **批量转诊**
   - 支持批量选择患者转诊
   - 提高操作效率

---

### 11.2 用户体验优化

1. **改进确认对话框**
   - 使用 Element Plus 的 MessageBox
   - 更好的视觉效果

2. **添加操作音效**
   - 转诊成功提示音
   - 错误提示音

3. **优化加载状态**
   - 骨架屏加载
   - 渐进式加载

---

### 11.3 性能优化

1. **减少 API 调用**
   - 缓存诊室列表
   - 智能刷新策略

2. **优化状态更新**
   - 使用 computed 优化计算
   - 减少不必要的重渲染

---

## 十二、总结

### 12.1 完成情况

✅ **核心功能**
- 分诊弹窗组件完整实现
- 转诊功能逻辑完善
- 确认对话框添加
- 自动呼叫下一位
- 完整的错误处理

✅ **用户体验**
- 友好的操作提示
- 清晰的成功/失败反馈
- 流畅的交互动画
- 响应式设计

✅ **代码质量**
- 清晰的代码结构
- 完善的错误处理
- 良好的注释
- 易于维护

---

### 12.2 技术亮点

1. **智能状态管理**
   - 自动更新患者列表
   - 自动清空在诊患者
   - 自动关闭分诊弹窗

2. **完整的操作流程**
   - 确认对话框防止误操作
   - 成功提示反馈
   - 自动呼叫下一位

3. **良好的用户体验**
   - 渐变色设计
   - 流畅动画
   - 响应式布局
   - 友好的错误提示

---

### 12.3 文档完善

- ✅ 功能说明文档
- ✅ API 接口文档
- ✅ 使用示例
- ✅ 测试指南
- ✅ 问题排查

---

**转诊功能已全部完成！** 🎉

新版医疗呼叫客户端现在具备完整的转诊功能，可以投入生产使用。

---

**文档结束**
